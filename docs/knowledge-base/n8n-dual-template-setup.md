# N8N Dual Template Setup - PEDS & Feature Analysis

## ðŸŽ¯ Updated Workflow Configuration

### **Step 1: Enhanced "Check Analysis Needed" Node**

Replace your existing "Check Analysis Needed" node with this enhanced version:

```javascript
// Enhanced analysis that detects ticket type and data completeness
const ticket = $input.all()[0].json;
const comments = ticket.fields.comment?.comments || [];

// Determine ticket type based on project and issue type
const projectKey = ticket.fields.project.key;
const issueType = ticket.fields.issuetype.name.toLowerCase();

let ticketType = 'FEATURE'; // Default to feature analysis
if (projectKey === 'PEDS' || issueType.includes('bug') || issueType.includes('defect')) {
  ticketType = 'PEDS';
}

// Check for code diff links in description and comments
const description = ticket.fields.description || '';
const allText = description + ' ' + comments.map(c => 
  typeof c.body === 'string' ? c.body : 
  c.body?.content?.map(item => item.content?.map(cc => cc.text).join('') || '').join('') || ''
).join(' ');

// Enhanced code diff detection patterns
const codeDiffPatterns = [
  /https?:\/\/.*gitlab.*\/(merge_requests|compare)/i,
  /https?:\/\/.*github.*\/pull/i,
  /https?:\/\/.*bitbucket.*\/pull-requests/i,
  /merge.*request/i,
  /pull.*request/i,
  /code.*diff/i,
  /diff.*link/i,
  /gitlab.*diff/i,
  /github.*diff/i
];

const hasCodeDiff = codeDiffPatterns.some(pattern => pattern.test(allText));

// Check if PEDS description is insufficient (for PEDS tickets only)
const insufficientDescription = ticketType === 'PEDS' && (
  !description || 
  description.length < 50 || 
  description.toLowerCase().includes('see attachment only') ||
  description.toLowerCase().includes('as discussed verbally') ||
  description.toLowerCase().includes('check logs') ||
  /^.{1,30}$/.test(description.trim()) ||
  description.trim().split(' ').length < 10
);

// Check for existing analysis
const analysisKeywords = [
  'ðŸ” Issue Analysis',
  'ðŸš€ Feature Analysis', 
  'Analysis Report',
  'Generated by AI automated',
  'PEDS analysis tool',
  'feature analysis tool'
];

const hasAnalysis = comments.some(comment => {
  let bodyText = '';
  
  if (typeof comment.body === 'string') {
    bodyText = comment.body;
  } else if (comment.body && comment.body.content) {
    bodyText = comment.body.content
      .map(item => item.content?.map(c => c.text).join('') || '')
      .join('');
  }
  
  return bodyText && analysisKeywords.some(keyword => bodyText.includes(keyword));
});

// Log analysis details for debugging
console.log('Ticket Analysis Details:');
console.log('- Project:', projectKey);
console.log('- Issue Type:', issueType);
console.log('- Determined Type:', ticketType);
console.log('- Has Code Diff:', hasCodeDiff);
console.log('- Insufficient Description:', insufficientDescription);
console.log('- Has Existing Analysis:', hasAnalysis);

return {
  ticket_key: ticket.key,
  summary: ticket.fields.summary,
  status: ticket.fields.status.name,
  description: description,
  created: ticket.fields.created,
  project: projectKey,
  issue_type: issueType,
  ticket_type: ticketType,
  needs_analysis: !hasAnalysis,
  has_code_diff: hasCodeDiff,
  insufficient_description: insufficientDescription,
  full_ticket: ticket
};
```

### **Step 2: Updated "Read Repository Files" Node**

Update your existing node to include both templates:

```javascript
const fs = require('fs');
const path = require('path');

// N8N server knowledge base path
const docsPath = '/opt/n8n/knowledge-base';

// Essential files for comprehensive analysis
const essentialFiles = [
  'templates/peds-analysis-template.md',
  'templates/feature-analysis-template.md',
  'methodology/peds-analysis-methodology.md', 
  'methodology/code-analysis-patterns.md',
  'platform/smartech-architecture-overview.md',
  'platform/netcore_jira_reference.md',
  'patterns/component-root-cause-mapping.md',
  'debugging/smartech-qa-debugging-handbook.md',
  'patterns/common-fixes-database.md'
];

// Additional context files
const additionalFiles = [
  'debugging/api-integration-procedures.md',
  'debugging/database-debugging-procedures.md', 
  'debugging/email-debugging-procedures.md',
  'platform/api-documentation.md',
  'platform/campaign-management.md',
  'testing/qa-processes.md',
  'testing/component-dependencies.md'
];

const allFiles = [...essentialFiles, ...additionalFiles];

let contextData = `
=== NETCORE SMARTECH ANALYSIS SYSTEM ===

You are a senior analyst for Netcore Solutions with expertise in both bug analysis (PEDS) and feature analysis (SMT/CEPI).
Your task is to analyze JIRA tickets using comprehensive platform knowledge and provide appropriate analysis based on ticket type.

ANALYSIS REQUIREMENTS:
1. âœ… Determine ticket type (PEDS vs FEATURE) and use appropriate template
2. âœ… Include warning sections when data is incomplete
3. âœ… Apply platform-specific knowledge for technical accuracy
4. âœ… Reference debugging procedures and common patterns
5. âœ… Provide actionable testing strategies
6. âœ… Include automation gap analysis where applicable

KNOWLEDGE BASE CONTENT:
`;

let filesLoaded = [];
let filesMissing = [];
let essentialMissing = 0;

allFiles.forEach(fileName => {
  const filePath = path.join(docsPath, fileName);
  if (fs.existsSync(filePath)) {
    try {
      const content = fs.readFileSync(filePath, 'utf8');
      contextData += `\n\n=== ${fileName.toUpperCase()} ===\n${content}`;
      filesLoaded.push(fileName);
    } catch (error) {
      filesMissing.push(`${fileName} (read error: ${error.message})`);
      if (essentialFiles.includes(fileName)) essentialMissing++;
    }
  } else {
    filesMissing.push(`${fileName} (not found)`);
    if (essentialFiles.includes(fileName)) essentialMissing++;
  }
});

contextData += `\n\n=== END KNOWLEDGE BASE ===`;

// Log summary
console.log('=== KNOWLEDGE BASE LOADING SUMMARY ===');
console.log(`Total files loaded: ${filesLoaded.length}/${allFiles.length}`);
console.log(`Essential files loaded: ${filesLoaded.filter(f => essentialFiles.includes(f)).length}/${essentialFiles.length}`);
console.log(`Essential files missing: ${essentialMissing}`);

if (essentialMissing > 0) {
  console.warn(`âš ï¸  WARNING: ${essentialMissing} essential files missing - analysis quality may be reduced`);
}

return {
  repository_context: contextData,
  ticket_info: $json,
  knowledge_summary: {
    total_files: allFiles.length,
    files_loaded: filesLoaded.length,
    essential_loaded: filesLoaded.filter(f => essentialFiles.includes(f)).length,
    essential_missing: essentialMissing,
    base_path: docsPath,
    ready_for_analysis: essentialMissing <= 1 // Allow for 1 missing file
  }
};
```

### **Step 3: Updated Claude Analysis Node**

Replace your Claude Analysis node with this intelligent version:

```json
{
  "model": "claude-3-5-sonnet-20241022",
  "max_tokens": 4000,
  "messages": [
    {
      "role": "user", 
      "content": "{{ 'You are a senior analyst for Netcore Solutions. Analyze this ticket and use the appropriate template based on ticket type.\\n\\n' + $json.repository_context + '\\n\\n=== TICKET ANALYSIS REQUEST ===\\n\\nTicket: ' + $node['Check Analysis Needed'].json.ticket_key + '\\nProject: ' + $node['Check Analysis Needed'].json.project + '\\nIssue Type: ' + $node['Check Analysis Needed'].json.issue_type + '\\nDetermined Type: ' + $node['Check Analysis Needed'].json.ticket_type + '\\nSummary: ' + $node['Check Analysis Needed'].json.summary + '\\nStatus: ' + $node['Check Analysis Needed'].json.status + '\\nDescription: ' + ($node['Check Analysis Needed'].json.description || 'No description provided') + '\\nHas Code Diff: ' + $node['Check Analysis Needed'].json.has_code_diff + '\\nInsufficient Description: ' + $node['Check Analysis Needed'].json.insufficient_description + '\\n\\nCRITICAL REQUIREMENTS:\\n\\n' + ($node['Check Analysis Needed'].json.ticket_type === 'PEDS' ? 'ðŸ”§ USE PEDS TEMPLATE: This is a bug fix - use the PEDS Analysis Template format exactly\\n' : 'ðŸš€ USE FEATURE TEMPLATE: This is a feature/enhancement - use the SMT/CEPI Feature Analysis Template format exactly\\n') + '\\n1. ðŸ“‹ EXACT TEMPLATE: Follow the precise template structure from knowledge base\\n2. âš ï¸ INCLUDE WARNINGS: Add warning sections based on data completeness:\\n' + ($node['Check Analysis Needed'].json.has_code_diff === false ? '   - Include \"No code diff link found\" warning\\n' : '') + ($node['Check Analysis Needed'].json.insufficient_description === true ? '   - Include \"Insufficient description\" warning\\n' : '') + '3. ðŸ—ï¸ PLATFORM KNOWLEDGE: Use Smartech architecture and component knowledge\\n4. ðŸ”§ DEBUGGING GUIDANCE: Reference appropriate debugging procedures\\n5. ðŸ§ª TESTING STRATEGY: Provide specific, actionable test cases\\n6. ðŸ“Š BUSINESS IMPACT: Focus on customer and business implications\\n\\nGenerate comprehensive analysis following the exact template format with all required sections and appropriate warnings.' }}"
    }
  ]
}
```

## ðŸš€ Deployment Steps

### **Phase 1: Deploy Updated Templates**

```bash
# Deploy both templates to n8n server
scp docs/templates/peds-analysis-template.md user@n8n-server:/opt/n8n/knowledge-base/templates/
scp docs/templates/feature-analysis-template.md user@n8n-server:/opt/n8n/knowledge-base/templates/

# Verify both templates are present
ssh user@n8n-server "ls -la /opt/n8n/knowledge-base/templates/"
```

### **Phase 2: Update N8N Workflow Nodes**

1. **Update "Check Analysis Needed" Node:**
   - Replace JavaScript code with enhanced version above
   - This adds ticket type detection and data completeness checking

2. **Update "Read Repository Files" Node:**
   - Add feature-analysis-template.md to essential files list
   - This ensures both templates are loaded

3. **Update "Claude Analysis" Node:**
   - Replace JSON body with intelligent template selection
   - This automatically chooses the right template based on ticket type

### **Phase 3: Test Both Templates**

```bash
# Test PEDS ticket analysis
# - Create test with project = PEDS, issuetype = Bug
# - Should use PEDS template with warnings if no code diff

# Test Feature ticket analysis  
# - Create test with project = SMT/CEPI, issuetype = Story/Feature
# - Should use Feature template with warnings if no code diff
```

### **Phase 4: Validation Checklist**

âœ… Both templates deployed to `/opt/n8n/knowledge-base/templates/`  
âœ… Enhanced "Check Analysis Needed" node detects ticket types  
âœ… "Read Repository Files" loads both templates  
âœ… Claude node intelligently selects appropriate template  
âœ… Warning sections appear when data is incomplete  
âœ… Test cases vary appropriately (P0/P1 for PEDS vs comprehensive for features)  

## ðŸŽ¯ Expected Results

### **For PEDS Tickets (Bugs):**
- Uses PEDS Analysis Template
- Shows warnings for missing code diff or insufficient description
- Focus on root cause and fix validation
- P0/P1 test case structure

### **For SMT/CEPI Tickets (Features):**
- Uses Feature Analysis Template  
- Shows warnings for missing code diff
- Focus on business value and comprehensive testing
- Multi-tier test case structure (P0/P1/Edge Cases/Regression)

### **Automatic Intelligence:**
- Detects ticket type from project + issue type
- Applies appropriate warnings based on data availability
- Uses relevant knowledge base sections for each template
- Maintains professional quality regardless of template used

The workflow now provides **context-aware analysis** that adapts to both bug fixes and new features! ðŸš€
